;This is absolutely hideous code, only intended as a quick demo.

.PC02

.INCLUDE "INSTRUCTIONS.MAC"
.INCLUDE "XM7SEG.MAC"

	XMICRO_MEMORY = $7100
	RTC = XMICRO_MEMORY+$10

	XMICRO_SERIAL = $7200
	PS2_DATA = XMICRO_SERIAL+$10
	PS2_SR = XMICRO_SERIAL+$11

.SEGMENT "ZEROPAGE"

RTC_HOUR: 		.RES 1
RTC_MINUTE:		.RES 1
RTC_SECOND:		.RES 1

PS2_READBUFFER:		.RES 2
PS2_READSTATUS:		.RES 1

.SEGMENT "STARTUP"
_INIT:
	SEI
	CLC
	LDX #$FF
	TXS

	JSR XM7SEG_INIT
	XM7SEG_ON

	LDA #$4C		;LOAD VECTOR WITH RTC ISR
	STA $0204
	LDA #.LOBYTE(RTC_ISR)
	STA $0205
	LDA #.HIBYTE(RTC_ISR)
	STA $0206

	LDA #$4C		;LOAD VECTOR WITH PS2 ISR
	STA $0208
	LDA #.LOBYTE(PS2_ISR)
	STA $0209
	LDA #.HIBYTE(PS2_ISR)
	STA $020A

	LDA #%00000000		;SET ALARM RATE
	STA RTC+$01
	STA RTC+$03
	STA RTC+$05
	STA RTC+$07

	LDA RTC+$0B		;SET PERIODIC INTERRUPT RATE
	AND #%11110000
	ORA #%00000101		;488uS
	STA RTC+$0B

;	LDA #%00001000		;ONLY ENABLE ALARM INTERRUPT
	LDA #%00000100		;ONLY ENABLE PERIODIC INTERRUPT
	STA RTC+$0C

	LDA RTC+$0E
	ORA #%00000110		;SET 24 HOUR MODE
;	AND #%11111011		;SET 12 HOUR MODE
	STA RTC+$0E

	LDX #$00
	TXA
	TAY
	CLI

	JMP _MAIN

.SEGMENT "CODE"

_MAIN:
	WAI
	JMP _MAIN

RTC_LOAD:
	LDA RTC+$0E
	ORA #%00001000
	STA RTC+$0E
	LDA RTC+$04
	STA RTC_HOUR
	LDA RTC+$02
	STA RTC_MINUTE
	LDA RTC+$00
	STA RTC_SECOND
	LDA RTC+$0E
	AND #%11110111
	STA RTC+$0E
	RTS

RTC_SET:
	LDA RTC+$0E		;SET TIME
	ORA #%00001000
	STA RTC+$0E
	LDA RTC_HOUR
	STA RTC+$04
	LDA RTC_MINUTE
	STA RTC+$02
	LDA RTC_SECOND
	STA RTC+$00
	LDA RTC+$0E
	AND #%11110111
	STA RTC+$0E
	RTS

RTC_ISR:
	LDA RTC+$0D		;FLAG REGISTER
;	AND #%00001000		;MASK ALARM FLAG
;	CMP #%00001000
	AND #%00000100		;MASK PI FLAG
	CMP #%00000100
	BEQ L0			;UPDATE DISPLAY IF THERE IS AN ALARM
	RTI

L0:	LDA RTC+$0E		;CONTROL REGISTER
	ORA #%00001000		;SET UTI BIT
	STA RTC+$0E

	LDA RTC+$02		;MINUTES
	STA XM7SEG_BUFFER+0
;	LDA RTC+$04		;12 HOUR CONVERSION
;	AND #%10000000		;CHECK FOR PM
;	BNE PM

AM:	LDA RTC+$04
	STA XM7SEG_BUFFER+1
	BRA SECS

PM:	LDA RTC+$04
	AND #%01111111
	SED
	CLC
	ADC #$12
	CLD
	STA XM7SEG_BUFFER+1

SECS:	LDA RTC+$00		;SECONDS
	STA XM7SEG_BUFFER+2

	LDA #%00101100		;DECIMAL POINT AND DISPLAY ENABLE
	STA XM7SEG_BUFFER+3

	JSR XM7SEG_WRITE	;WRITE DISPLAY DATA

	LDA RTC+$0E		;CONTROL REGISTER
	AND #%11110111		;CLEAR UTI BIT
	STA RTC+$0E
	RTI


PS2_ISR:
	LDA PS2_SR
	STA PS2_READSTATUS
	AND #%00100000		;CHECK INTERRUPT STATUS
	BNE PS2_READ_L0
	RTI

	PS2_READ_L0:
	LDA PS2_READSTATUS
	AND #%00010000		;CHECK FOR PARITY ERROR
	BEQ PS2_READ_L1
		LDX #$00
	ERROR_WAIT_L0:
		DEX
		NOP
		NOP
		NOP
		NOP
		NOP
		NOP
		BNE ERROR_WAIT_L0

	PS2_READ_L1:			;READ THE DATA
	LDA PS2_READBUFFER+0
	STA PS2_READBUFFER+1
	LDA PS2_DATA
	STA PS2_READBUFFER+0

	PS2_ACTION:
	LDA PS2_READBUFFER+1
	CMP #$F0		;CHECK IF WE HAVE A BREAK CODE
	BNE PS2_MAKE
	RTI

	PS2_MAKE:
	SED
	LDA PS2_READBUFFER+0
	CMP #$29		;SPACE BAR
	BEQ TIME_SYNC

	CMP #$75		;UP ARROW
	BEQ TMI_LOAD
	CMP #$72		;DOWN ARROW
	BEQ TMD_LOAD
	CMP #$74		;RIGHT ARROW
	BEQ THI_LOAD
	CMP #$6B		;LEFT ARROW
	BEQ THD_LOAD
	RTI


TMI_LOAD:
	JSR RTC_LOAD
	BRA TMI

THI_LOAD:
	JSR RTC_LOAD
	BRA THI

TMD_LOAD:
	JSR RTC_LOAD
	BRA TMD

THD_LOAD:
	JSR RTC_LOAD
	BRA THD

TIME_SYNC:
	JSR RTC_LOAD
	LDA RTC_SECOND
	CMP #$30
	BCS SYNC_L0			;INCREMENT MINUTE IF SECONDS >=30
	LDA #$00
	STA RTC_SECOND
	JSR RTC_SET
	RTI

SYNC_L0:
	LDA #$00
	STA RTC_SECOND
TMI:	LDA RTC_MINUTE
	CLC
	ADC #$01
	CMP #$60
	BEQ SYNC_L1			;INCREMENT HOUR IF MINUTE = 60
	STA RTC_MINUTE
	JSR RTC_SET
	RTI

SYNC_L1:
	LDA #$00
	STA RTC_MINUTE
THI:	LDA RTC_HOUR
	CLC
	ADC #$01
	CMP #$24
	BEQ SYNC_L2			;ZERO HOUR IF =24
	STA RTC_HOUR
	JSR RTC_SET
	RTI

SYNC_L2:
	LDA #$00
	STA RTC_HOUR
	JSR RTC_SET
	RTI


TMD:
	LDA RTC_MINUTE
	BEQ TMD_L1			;DECREMENT HOUR IF =0
	SEC
	SBC #$01
	STA RTC_MINUTE
	JSR RTC_SET
	RTI

TMD_L1:
	LDA #$59
	STA RTC_MINUTE
THD:	LDA RTC_HOUR
	BEQ THD_L1
	SEC
	SBC #$01
	STA RTC_HOUR
	JSR RTC_SET
	RTI

THD_L1:
	LDA #$23
	STA RTC_HOUR
	JSR RTC_SET
	RTI
