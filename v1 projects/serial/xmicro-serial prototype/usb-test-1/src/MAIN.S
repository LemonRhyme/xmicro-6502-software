.PC02

.INCLUDE "INSTRUCTIONS.MAC"
.INCLUDE "XM7SEG.MAC"
.INCLUDE "SERIAL.MAC"

.SEGMENT "ZEROPAGE"
SECONDS_BUFFER:	.RES 2


.SEGMENT "STARTUP"

XMICRO_MEMORY = $1100
RTC = XMICRO_MEMORY+$10


_INIT:
	SEI
	CLC
	LDX #$FF
	TXS

;----RTC INIT---
	LDA #$4C		;LOAD VECTOR WITH RTC ISR
	STA $0204
	LDA #.LOBYTE(RTC_ISR)
	STA $0205
	LDA #.HIBYTE(RTC_ISR)
	STA $0206

	LDA #%11000000		;SET ALARM RATE TO EVERY SECOND
	STA RTC+$01
	STA RTC+$03
	STA RTC+$05
	STA RTC+$07

;	LDA #%00001000		;ONLY ENABLE ALARM INTERRUPT
	LDA #%00000000		;DISABLE INTERRUPTS
	STA RTC+$0C

	LDA RTC+$0E
	ORA #%00000110		;SET 24 HOUR MODE
	STA RTC+$0E
;----RTC INIT---

	JSR SERIAL_INIT
	JSR XM7SEG_INIT
	XM7SEG_ON
	XM7SEG_WORD #$1111

	LDX #$00
	TXA
	TAY
	CLI

	LDA #$5E
	STA SERIAL_TXBUFFER
	LDA #$00
	JSR SERIAL_TX

	JMP _MAIN

.SEGMENT "CODE"

_MAIN:
	JMP _MAIN


RTC_ISR:
	LDA RTC+$0D		;FLAG REGISTER
	AND #%00001000		;MASK ALARM FLAG
	CMP #%00001000
	BEQ L0			;UPDATE DISPLAY IF THERE IS AN ALARM
	RTI

L0:	LDA RTC+$0E		;CONTROL REGISTER
	ORA #%00001000		;SET UTI BIT
	STA RTC+$0E

SECS:	LDA RTC+$00		;SECONDS
	STA SECONDS_BUFFER

	LDA RTC+$0E		;CONTROL REGISTER
	AND #%11110111		;CLEAR UTI BIT
	STA RTC+$0E

	LDA SECONDS_BUFFER
	STA SERIAL_TXBUFFER
	JSR SERIAL_TX

	RTI
